<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCB-CCHD Rounds - AAP 2022 Guidelines</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; }
        .mono { font-family: 'JetBrains+Mono', monospace; }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator { display: none; }

        .neutral-card { background: #ffffff; border: 1px solid #E2E8F0; }
        .risk-active { background-color: #EF4444 !important; border-color: #B91C1C !important; }
        .risk-active * { color: white !important; }
        
        .copy-sidebar {
            width: 10%;
            min-width: 45px;
            max-width: 60px;
            background-color: #4F46E5;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
        }
        .copy-sidebar:hover { background-color: #4338CA; }
        
        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
        }

        .input-group { background-color: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 0.75rem; padding: 0.4rem 0.6rem; }
        
        /* Modal Animation */
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="h-screen overflow-hidden text-slate-900">
    <!-- AAP Guideline Modal -->
    <div id="guide-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-xl font-black text-slate-800">AAP 2022 Guidelines Summary</h3>
                    <p class="text-indigo-600 font-bold text-[10px] uppercase tracking-wider">Hyperbilirubinemia Management Revision</p>
                </div>
                <button onclick="toggleModal()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-400 transition-colors">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6 text-sm text-slate-600 leading-relaxed">
                <section>
                    <h4 class="font-black text-slate-900 text-xs uppercase tracking-widest mb-2 flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span> Phototherapy Thresholds
                    </h4>
                    <ul class="list-disc ml-5 space-y-1">
                        <li>Thresholds for phototherapy have been updated for 2022.</li>
                        <li>Initial level is based on GA and Neurotoxicity Risk.</li>
                        <li>This calculator uses the matrix from the Supplemental Tables 1,2, 3, and 4 from the AAP 2022 Guideliness.</li>
                    </ul>
                </section>
                <section>
                    <h4 class="font-black text-slate-900 text-xs uppercase tracking-widest mb-2 flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span> Neurotoxicity Risk Factors
                    </h4>
                    <p class="text-[11px] font-bold text-slate-400 italic mb-2">Presence of these lowers thresholds by ~2-3 mg/dL:</p>
                    <ul class="list-disc ml-5 space-y-1">
                        <li><strong>Gestational Age:</strong> All infants < 38 weeks (automatic risk).</li>
                        <li><strong>Albumin:</strong> Level < 3.0 g/dL.</li>
                        <li><strong>Hemolysis:</strong> Isoimmune disease (DAT+), G6PD, or other.</li>
                        <li><strong>Sepsis:</strong> Clinically suspected or proven.</li>
                        <li><strong>Instability:</strong> Significant acidosis/respiratory distress in prior 24h.</li>
                    </ul>
                </section>
                <section>
                    <h4 class="font-black text-slate-900 text-xs uppercase tracking-widest mb-2 flex items-center gap-2">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Key Clinical Pearls
                    </h4>
                    <ul class="list-disc ml-5 space-y-1">
                        <li><strong>Direct Bilirubin:</strong> No longer subtracted from total for treatment decisions.</li>
                        <li><strong>Discontinuation:</strong> Stop when TSB is >= 2 mg/dL below start threshold.</li>
                        <li><strong>Follow-up:</strong> Timing depends on the "distance" between current TSB/TCB and the phototherapy line.</li>
                    </ul>
                </section>
                <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 flex items-center justify-between gap-4">
                    <p class="text-[10px] font-bold text-indigo-700 uppercase">Access original publication</p>
                    <a href="https://publications.aap.org/pediatrics/article/150/3/e2022058859/188726/Clinical-Practice-Guideline-Revision-Management-of" target="_blank" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-bold uppercase hover:bg-indigo-700 transition-all flex items-center gap-2">
                        Full Article <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    </a>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-100 text-center">
                <button onclick="toggleModal()" class="text-slate-400 hover:text-slate-600 font-bold text-[10px] uppercase tracking-widest">Dismiss</button>
            </div>
        </div>
    </div>

    <div id="app" class="flex flex-col md:flex-row w-full h-full">
        <!-- Input Section -->
        <div class="w-full md:w-3/5 h-1/2 md:h-full overflow-auto p-4 border-b md:border-b-0 md:border-r border-slate-200">
            <div class="max-w-5xl mx-auto">
                <header class="mb-4">
                    <div class="flex items-start justify-between w-full">
                        <!-- Left Aligned Branding and Blurbs -->
                        <div class="flex flex-col items-start gap-1">
                            <h1 class="text-2xl font-black text-slate-800 tracking-tight">TCB-CCHD Rounds</h1>
                            
                            <button onclick="toggleModal()" class="text-slate-400 text-[10px] font-bold uppercase tracking-widest hover:text-indigo-600 transition-colors flex items-center gap-1.5 mb-2">
                                AAP 2022 CLINICAL GUIDANCE <i class="fa-solid fa-circle-info text-[11px]"></i>
                            </button>
                            
                            <!-- Rationale Blurbs aligned directly with the Title -->
                            <div class="hidden sm:flex items-start gap-8 border-l-2 border-slate-200 pl-4 py-1">
                                <div class="max-w-[220px]">
                                    <p class="text-[8px] font-black text-indigo-600 uppercase mb-0.5 tracking-wider">Neurotoxicity Risk Factors</p>
                                    <p class="text-[9px] leading-tight text-slate-500 italic">GA < 38wk ‚Ä¢ Albumin < 3.0 ‚Ä¢ Hemolytic disease (DAT+, G6PD) ‚Ä¢ Sepsis ‚Ä¢ Clinical Instability (24h)</p>
                                </div>
                                <div class="max-w-[180px]">
                                    <p class="text-[8px] font-black text-rose-500 uppercase mb-0.5 tracking-wider">CCHD Screening</p>
                                    <p class="text-[9px] leading-tight text-slate-500 italic">Mandatory pulse oximetry. Requires >=95% and <=3% difference.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Aligned Assessment Time Control -->
                        <div class="shrink-0">
                            <div class="flex flex-col items-end gap-1.5 bg-white p-2.5 rounded-xl border border-slate-200 shadow-sm">
                                <label class="flex items-center gap-2.5 cursor-pointer">
                                    <input type="checkbox" id="override-toggle" onchange="toggleOverride()" class="w-4 h-4 text-indigo-600 rounded-md border-slate-300 focus:ring-indigo-500">
                                    <span id="override-label" class="text-[10px] font-black text-slate-600 uppercase tracking-wide">manually input assessment time?</span>
                                </label>
                                <div id="override-inputs" class="hidden flex items-center justify-end gap-1.5 border-t pt-2 border-slate-100">
                                    <div class="bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200 flex items-center gap-2">
                                        <input id="manual-date" type="date" class="text-[11px] font-bold outline-none bg-transparent w-[95px]">
                                        <i class="fa-solid fa-calendar text-slate-400 text-[10px]"></i>
                                    </div>
                                    <div class="bg-slate-50 px-2 py-1.5 rounded-lg border border-slate-200 flex items-center gap-2">
                                        <input id="manual-time" type="time" class="text-[11px] font-bold outline-none bg-transparent w-[65px]">
                                        <i class="fa-solid fa-clock text-slate-400 text-[10px]"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <div id="babies-container" class="space-y-4"></div>

                <button onclick="addBaby()" class="w-full mt-6 py-4 bg-white border-2 border-dashed border-slate-300 rounded-xl text-slate-400 hover:text-indigo-600 hover:border-indigo-300 transition-all font-bold text-xs flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus"></i> ADD PATIENT
                </button>
                <div class="h-20"></div>
            </div>
        </div>

        <!-- Output Section -->
        <div class="w-full md:w-2/5 h-1/2 md:h-full p-4 bg-slate-900 flex flex-col">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-white font-bold text-[10px] tracking-widest uppercase">Clinical Summary</h2>
                <button onclick="copyFullReport()" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase">Copy All</button>
            </div>
            <div class="bg-slate-950 p-4 rounded-xl border border-slate-800 flex-grow overflow-auto">
                <pre id="output-preview" class="mono text-[11px] text-indigo-50 whitespace-pre-wrap">Awaiting clinical data...</pre>
            </div>
        </div>
    </div>

    <script>
        // State
        const RAW_DATA = {
            // PART 1: Phototherapy No Risk
            p1_40: [
                null, 8.9, 9.1, 9.3, 9.6, 9.8, 10.0, 10.2, 10.4, 10.5, 10.7, 10.9, 11.1, 11.3, 11.5, 11.7, 11.9, 12.1, 12.2, 12.4, 12.6, 12.8, 13.0, 13.1, // D0
                13.3, 13.5, 13.6, 13.8, 14.0, 14.1, 14.3, 14.5, 14.6, 14.8, 15.0, 15.1, 15.3, 15.4, 15.6, 15.7, 15.9, 16.0, 16.2, 16.3, 16.4, 16.6, 16.7, 16.9, // D1
                17.0, 17.1, 17.3, 17.4, 17.5, 17.7, 17.8, 17.9, 18.0, 18.2, 18.3, 18.4, 18.5, 18.6, 18.8, 18.9, 19.0, 19.1, 19.2, 19.3, 19.4, 19.6, 19.7, 19.7, // D2
                19.8, 19.9, 20.0, 20.1, 20.2, 20.3, 20.4, 20.5, 20.6, 20.7, 20.7, 20.8, 20.9, 21.0, 21.1, 21.1, 21.2, 21.3, 21.4, 21.4, 21.5, 21.6, 21.6, 21.7, // D3
                ...Array(241).fill(21.8) // D4-D14
            ],
            p1_39: [
                null, 8.4, 8.6, 8.8, 9.0, 9.3, 9.5, 9.7, 9.9, 10.0, 10.2, 10.4, 10.6, 10.8, 11.0, 11.2, 11.4, 11.6, 11.8, 11.9, 12.1, 12.3, 12.5, 12.7, // D0
                12.8, 13.0, 13.2, 13.3, 13.5, 13.7, 13.8, 14.0, 14.2, 14.3, 14.5, 14.7, 14.8, 15.0, 15.1, 15.3, 15.4, 15.6, 15.7, 15.9, 16.0, 16.2, 16.3, 16.4, // D1
                16.6, 16.7, 16.8, 17.0, 17.1, 17.2, 17.4, 17.5, 17.6, 17.8, 17.9, 18.0, 18.1, 18.2, 18.4, 18.5, 18.6, 18.7, 18.8, 18.9, 19.0, 19.1, 19.2, 19.3, // D2
                19.5, 19.6, 19.7, 19.7, 19.8, 19.9, 20.0, 20.1, 20.2, 20.3, 20.4, 20.5, 20.6, 20.6, 20.7, 20.8, 20.9, 21.0, 21.0, 21.1, 21.2, 21.3, 21.3, 21.4, // D3
                ...Array(241).fill(21.8)
            ],
            p1_38: [
                null, 7.9, 8.1, 8.3, 8.5, 8.7, 8.9, 9.1, 9.3, 9.5, 9.7, 9.9, 10.1, 10.3, 10.5, 10.7, 10.8, 11.0, 11.2, 11.4, 11.6, 11.7, 11.9, 12.1, // D0
                12.3, 12.4, 12.6, 12.8, 12.9, 13.1, 13.3, 13.4, 13.6, 13.8, 13.9, 14.1, 14.2, 14.4, 14.5, 14.7, 14.8, 15.0, 15.1, 15.3, 15.4, 15.6, 15.7, 15.8, // D1
                16.0, 16.1, 16.2, 16.4, 16.5, 16.6, 16.8, 16.9, 17.0, 17.1, 17.3, 17.4, 17.5, 17.6, 17.7, 17.8, 17.9, 18.1, 18.2, 18.3, 18.4, 18.5, 18.6, 18.7, // D2
                18.8, 18.9, 19.0, 19.1, 19.2, 19.3, 19.4, 19.5, 19.5, 19.6, 19.7, 19.8, 19.9, 20.0, 20.0, 20.1, 20.2, 20.3, 20.3, 20.4, 20.5, 20.6, 20.6, 20.7, // D3
                ...Array(241).fill(21.8)
            ],
            p1_37: [
                null, 7.4, 7.6, 7.8, 8.0, 8.2, 8.4, 8.6, 8.8, 9.0, 9.2, 9.4, 9.6, 9.8, 9.9, 10.1, 10.3, 10.5, 10.7, 10.8, 11.0, 11.2, 11.4, 11.5, // D0
                11.7, 11.9, 12.1, 12.2, 12.4, 12.5, 12.7, 12.9, 13.0, 13.2, 13.3, 13.5, 13.6, 13.8, 13.9, 14.1, 14.2, 14.4, 14.5, 14.7, 14.8, 15.0, 15.1, 15.2, // D1
                15.4, 15.5, 15.6, 15.8, 15.9, 16.0, 16.1, 16.3, 16.4, 16.5, 16.6, 16.7, 16.9, 17.0, 17.1, 17.2, 17.3, 17.4, 17.5, 17.6, 17.7, 17.8, 17.9, 18.0, // D2
                18.1, 18.2, 18.3, 18.4, 18.5, 18.6, 18.7, 18.8, 18.9, 19.0, 19.0, 19.1, 19.2, 19.3, 19.4, 19.4, 19.5, 19.6, 19.7, 19.7, 19.8, 19.9, 19.9, 20.0, // D3
                ...Array(241).fill(21.1)
            ],
            p1_36: [
                null, 6.9, 7.1, 7.3, 7.5, 7.7, 7.9, 8.1, 8.3, 8.5, 8.7, 8.8, 9.0, 9.2, 9.4, 9.6, 9.8, 9.9, 10.1, 10.3, 10.5, 10.6, 10.8, 11.0, // D0
                11.2, 11.3, 11.5, 11.7, 11.8, 12.0, 12.1, 12.3, 12.5, 12.6, 12.8, 12.9, 13.1, 13.2, 13.4, 13.5, 13.7, 13.8, 13.9, 14.1, 14.2, 14.4, 14.5, 14.6, // D1
                14.8, 14.9, 15.0, 15.1, 15.3, 15.4, 15.5, 15.6, 15.8, 15.9, 16.0, 16.1, 16.2, 16.3, 16.5, 16.6, 16.7, 16.8, 16.9, 17.0, 17.1, 17.2, 17.3, 17.4, // D2
                17.5, 17.6, 17.7, 17.8, 17.9, 17.9, 18.0, 18.1, 18.1, 18.2, 18.3, 18.4, 18.4, 18.5, 18.6, 18.7, 18.8, 18.8, 18.9, 19.0, 19.0, 19.1, 19.2, 19.3, // D3
                ...Array(241).fill(20.4)
            ],
            p1_35: [
                null, 6.4, 6.6, 6.8, 7.0, 7.2, 7.4, 7.6, 7.8, 7.9, 8.1, 8.3, 8.5, 8.7, 8.9, 9.0, 9.2, 9.4, 9.6, 9.8, 9.9, 10.1, 10.3, 10.4, // D0
                10.6, 10.8, 10.9, 11.1, 11.3, 11.4, 11.6, 11.7, 11.9, 12.0, 12.2, 12.3, 12.5, 12.6, 12.8, 12.9, 13.1, 13.2, 13.4, 13.5, 13.6, 13.8, 13.9, 14.0, // D1
                14.2, 14.3, 14.4, 14.5, 14.7, 14.8, 14.9, 15.0, 15.1, 15.3, 15.4, 15.5, 15.6, 15.7, 15.8, 15.9, 16.0, 16.1, 16.2, 16.3, 16.4, 16.5, 16.6, 16.7, // D2
                16.8, 16.9, 17.0, 17.1, 17.2, 17.3, 17.4, 17.5, 17.5, 17.6, 17.7, 17.8, 17.8, 17.9, 18.0, 18.1, 18.1, 18.2, 18.3, 18.3, 18.4, 18.5, 18.5, 18.6, // D3
                ...Array(241).fill(19.6)
            ],

            // PART 2: Phototherapy With Risk
            p2_38: [
                null, 6.4, 6.6, 6.8, 7.0, 7.2, 7.3, 7.5, 7.7, 7.9, 8.1, 8.3, 8.5, 8.6, 8.8, 9.0, 9.2, 9.4, 9.5, 9.7, 9.9, 10.0, 10.2, 10.4, // D0
                10.5, 10.7, 10.8, 11.0, 11.2, 11.3, 11.5, 11.6, 11.8, 11.9, 12.1, 12.2, 12.4, 12.5, 12.7, 12.8, 12.9, 13.1, 13.2, 13.3, 13.5, 13.6, 13.7, 13.9, // D1
                14.0, 14.1, 14.2, 14.4, 14.5, 14.6, 14.7, 14.8, 14.9, 15.1, 15.2, 15.3, 15.4, 15.5, 15.6, 15.7, 15.8, 15.9, 16.0, 16.1, 16.2, 16.3, 16.4, 16.5, // D2
                16.6, 16.6, 16.7, 16.8, 16.9, 17.0, 17.1, 17.1, 17.2, 17.3, 17.4, 17.4, 17.5, 17.6, 17.6, 17.7, 17.8, 17.8, 17.9, 18.0, 18.0, 18.1, 18.1, 18.2, // D3
                ...Array(241).fill(18.2)
            ],
            p2_37: [
                null, 5.9, 6.1, 6.3, 6.5, 6.7, 6.9, 7.0, 7.2, 7.4, 7.6, 7.8, 8.0, 8.1, 8.3, 8.5, 8.7, 8.9, 9.0, 9.2, 9.4, 9.5, 9.7, 9.9, // D0
                10.0, 10.2, 10.4, 10.5, 10.7, 10.8, 11.0, 11.1, 11.3, 11.4, 11.6, 11.7, 11.9, 12.0, 12.2, 12.3, 12.4, 12.6, 12.7, 12.9, 13.0, 13.1, 13.2, 13.4, // D1
                13.5, 13.6, 13.8, 13.9, 14.0, 14.1, 14.2, 14.4, 14.5, 14.6, 14.7, 14.8, 14.9, 15.0, 15.1, 15.2, 15.3, 15.4, 15.5, 15.6, 15.7, 15.8, 15.9, 16.0, // D2
                16.1, 16.2, 16.3, 16.4, 16.5, 16.6, 16.6, 16.7, 16.8, 16.9, 17.0, 17.0, 17.1, 17.2, 17.2, 17.3, 17.4, 17.4, 17.5, 17.6, 17.6, 17.7, 17.8, 17.8, // D3
                ...Array(241).fill(18.2)
            ],
            p2_36: [
                null, 5.4, 5.6, 5.8, 6.0, 6.2, 6.3, 6.5, 6.7, 6.9, 7.1, 7.3, 7.4, 7.6, 7.8, 8.0, 8.1, 8.3, 8.5, 8.6, 8.8, 9.0, 9.1, 9.3, // D0
                9.4, 9.6, 9.8, 9.9, 10.1, 10.2, 10.4, 10.5, 10.7, 10.8, 11.0, 11.1, 11.2, 11.4, 11.5, 11.7, 11.8, 11.9, 12.1, 12.2, 12.3, 12.5, 12.6, 12.7, // D1
                12.8, 13.0, 13.1, 13.2, 13.3, 13.4, 13.5, 13.7, 13.8, 13.9, 14.0, 14.1, 14.2, 14.3, 14.4, 14.5, 14.6, 14.7, 14.8, 14.9, 15.0, 15.1, 15.2, 15.3, // D2
                15.4, 15.4, 15.5, 15.6, 15.7, 15.8, 15.8, 15.9, 16.0, 16.1, 16.1, 16.2, 16.3, 16.4, 16.4, 16.5, 16.6, 16.6, 16.7, 16.7, 16.8, 16.8, 16.9, 17.0, // D3
                ...Array(241).fill(18.2)
            ],
            p2_35: [
                null, 4.9, 5.1, 5.3, 5.5, 5.6, 5.8, 6.0, 6.2, 6.4, 6.5, 6.7, 6.9, 7.1, 7.2, 7.4, 7.6, 7.7, 7.9, 8.1, 8.2, 8.4, 8.6, 8.7, // D0
                8.9, 9.0, 9.2, 9.3, 9.5, 9.6, 9.8, 9.9, 10.1, 10.2, 10.3, 10.5, 10.6, 10.8, 10.9, 11.0, 11.2, 11.3, 11.4, 11.5, 11.7, 11.8, 11.9, 12.0, // D1
                12.2, 12.3, 12.4, 12.5, 12.6, 12.7, 12.8, 13.0, 13.1, 13.2, 13.3, 13.4, 13.5, 13.6, 13.7, 13.8, 13.9, 14.0, 14.1, 14.2, 14.2, 14.3, 14.4, 14.5, // D2
                14.6, 14.7, 14.8, 14.8, 14.9, 15.0, 15.1, 15.1, 15.2, 15.3, 15.3, 15.4, 15.5, 15.5, 15.6, 15.7, 15.7, 15.8, 15.8, 15.9, 15.9, 16.0, 16.1, 16.1, // D3
                ...Array(241).fill(17.4)
            ],

            // PART 3: Escalation No Risk
            p3_38: [
                null, 18.0, 18.2, 18.4, 18.5, 18.7, 18.8, 19.0, 19.1, 19.3, 19.4, 19.6, 19.7, 19.9, 20.0, 20.1, 20.3, 20.4, 20.6, 20.7, 20.8, 21.0, 21.1, 21.2, // D0
                21.4, 21.5, 21.6, 21.7, 21.9, 22.0, 22.1, 22.2, 22.3, 22.4, 22.6, 22.7, 22.8, 22.9, 23.0, 23.1, 23.2, 23.3, 23.4, 23.5, 23.6, 23.7, 23.8, 23.9, // D1
                24.0, 24.1, 24.2, 24.3, 24.4, 24.5, 24.6, 24.7, 24.7, 24.8, 24.9, 25.0, 25.1, 25.2, 25.2, 25.3, 25.4, 25.5, 25.5, 25.6, 25.7, 25.7, 25.8, 25.9, // D2
                25.9, 26.0, 26.0, 26.1, 26.2, 26.2, 26.3, 26.3, 26.4, 26.4, 26.5, 26.5, 26.6, 26.6, 26.7, 26.7, 26.7, 26.8, 26.8, 26.9, 26.9, 26.9, 27.0, 27.0, // D3
                ...Array(241).fill(27.0)
            ],
            p3_37: [
                null, 17.0, 17.1, 17.3, 17.5, 17.6, 17.8, 17.9, 18.1, 18.2, 18.4, 18.5, 18.7, 18.8, 18.9, 19.1, 19.2, 19.4, 19.5, 19.6, 19.8, 19.9, 20.1, 20.2, // D0
                20.3, 20.5, 20.6, 20.7, 20.8, 21.0, 21.1, 21.2, 21.3, 21.5, 21.6, 21.7, 21.8, 21.9, 22.1, 22.2, 22.3, 22.4, 22.5, 22.6, 22.7, 22.8, 22.9, 23.0, // D1
                23.1, 23.2, 23.3, 23.4, 23.5, 23.6, 23.7, 23.8, 23.9, 24.0, 24.1, 24.2, 24.3, 24.4, 24.5, 24.5, 24.6, 24.7, 24.8, 24.9, 24.9, 25.0, 25.1, 25.2, // D2
                25.2, 25.3, 25.4, 25.5, 25.5, 25.6, 25.7, 25.7, 25.8, 25.8, 25.9, 26.0, 26.0, 26.1, 26.1, 26.2, 26.2, 26.3, 26.3, 26.4, 26.4, 26.5, 26.5, 26.5, // D3
                ...Array(241).fill(27.0)
            ],
            p3_36: [
                null, 15.9, 16.1, 16.2, 16.4, 16.5, 16.7, 16.8, 16.9, 17.1, 17.2, 17.4, 17.5, 17.7, 17.8, 17.9, 18.1, 18.2, 18.3, 18.5, 18.6, 18.7, 18.9, 19.0, // D0
                19.1, 19.2, 19.4, 19.5, 19.6, 19.7, 19.9, 20.0, 20.1, 20.2, 20.4, 20.5, 20.6, 20.7, 20.8, 20.9, 21.0, 21.2, 21.3, 21.4, 21.5, 21.6, 21.7, 21.8, // D1
                21.9, 22.0, 22.1, 22.2, 22.3, 22.4, 22.5, 22.6, 22.7, 22.8, 22.9, 23.0, 23.1, 23.2, 23.2, 23.3, 23.4, 23.5, 23.6, 23.7, 23.8, 23.8, 23.9, 24.0, // D2
                24.1, 24.1, 24.2, 24.3, 24.4, 24.4, 24.5, 24.6, 24.6, 24.7, 24.8, 24.8, 24.9, 25.0, 25.0, 25.1, 25.2, 25.2, 25.3, 25.3, 25.4, 25.4, 25.5, 25.5, // D3
                ...Array(241).fill(27.0)
            ],
            p3_35: [
                null, 14.9, 15.0, 15.2, 15.4, 15.5, 15.7, 15.8, 15.9, 16.1, 16.2, 16.4, 16.5, 16.6, 16.8, 16.9, 17.1, 17.2, 17.3, 17.5, 17.6, 17.7, 17.9, 18.0, // D0
                18.1, 18.2, 18.4, 18.5, 18.6, 18.7, 18.9, 19.0, 19.1, 19.2, 19.4, 19.5, 19.6, 19.7, 19.8, 19.9, 20.0, 20.2, 20.3, 20.4, 20.5, 20.6, 20.7, 20.8, // D1
                20.9, 21.0, 21.1, 21.2, 21.3, 21.4, 21.5, 21.6, 21.7, 21.8, 21.9, 22.0, 22.1, 22.2, 22.2, 22.3, 22.4, 22.5, 22.6, 22.7, 22.8, 22.8, 22.9, 23.0, // D2
                23.1, 23.1, 23.2, 23.3, 23.4, 23.4, 23.5, 23.6, 23.6, 23.7, 23.8, 23.8, 23.9, 24.0, 24.0, 24.1, 24.2, 24.2, 24.3, 24.3, 24.4, 24.4, 24.5, 24.5, // D3
                ...Array(241).fill(25.0)
            ],

            // PART 4: Escalation With Risk
            p4_38: [
                null, 15.5, 15.7, 15.8, 16.0, 16.1, 16.3, 16.4, 16.6, 16.7, 16.9, 17.0, 17.2, 17.3, 17.4, 17.6, 17.7, 17.9, 18.0, 18.1, 18.3, 18.4, 18.5, 18.7, // D0
                18.8, 18.9, 19.0, 19.1, 19.3, 19.4, 19.5, 19.6, 19.7, 19.8, 20.0, 20.1, 20.2, 20.3, 20.4, 20.5, 20.6, 20.7, 20.8, 20.9, 21.0, 21.1, 21.2, 21.3, // D1
                21.4, 21.5, 21.6, 21.7, 21.8, 21.9, 22.0, 22.1, 22.1, 22.2, 22.3, 22.4, 22.5, 22.6, 22.6, 22.7, 22.8, 22.9, 22.9, 23.0, 23.1, 23.1, 23.2, 23.3, // D2
                23.3, 23.4, 23.4, 23.5, 23.6, 23.6, 23.7, 23.7, 23.8, 23.8, 23.9, 23.9, 24.0, 24.0, 24.1, 24.1, 24.1, 24.2, 24.2, 24.3, 24.3, 24.3, 24.4, 24.4, // D3
                ...Array(241).fill(24.4)
            ],
            p4_37: [
                null, 14.6, 14.8, 14.9, 15.1, 15.2, 15.4, 15.5, 15.7, 15.8, 16.0, 16.1, 16.3, 16.4, 16.5, 16.7, 16.8, 17.0, 17.1, 17.2, 17.4, 17.5, 17.7, 17.8, // D0
                17.9, 18.1, 18.2, 18.3, 18.4, 18.6, 18.7, 18.8, 18.9, 19.1, 19.2, 19.3, 19.4, 19.5, 19.7, 19.8, 19.9, 20.0, 20.1, 20.2, 20.3, 20.4, 20.5, 20.6, // D1
                20.7, 20.8, 20.9, 21.0, 21.1, 21.2, 21.3, 21.4, 21.5, 21.6, 21.7, 21.8, 21.9, 22.0, 22.1, 22.1, 22.2, 22.3, 22.4, 22.5, 22.5, 22.6, 22.7, 22.8, // D2
                22.8, 22.9, 23.0, 23.1, 23.1, 23.2, 23.3, 23.3, 23.4, 23.4, 23.5, 23.6, 23.6, 23.7, 23.7, 23.8, 23.8, 23.9, 23.9, 24.0, 24.0, 24.1, 24.1, 24.1, // D3
                ...Array(241).fill(24.1)
            ],
            p4_36: [
                null, 13.7, 13.9, 14.1, 14.2, 14.4, 14.5, 14.7, 14.8, 14.9, 15.1, 15.2, 15.4, 15.5, 15.7, 15.8, 15.9, 16.1, 16.2, 16.3, 16.5, 16.6, 16.7, 16.9, // D0
                17.0, 17.1, 17.3, 17.4, 17.5, 17.6, 17.8, 17.9, 18.0, 18.1, 18.3, 18.4, 18.5, 18.6, 18.7, 18.8, 18.9, 19.1, 19.2, 19.3, 19.4, 19.5, 19.6, 19.7, // D1
                19.8, 19.9, 20.0, 20.1, 20.2, 20.3, 20.4, 20.5, 20.6, 20.7, 20.8, 20.9, 21.0, 21.1, 21.1, 21.2, 21.3, 21.4, 21.5, 21.6, 21.7, 21.7, 21.8, 21.9, // D2
                22.0, 22.0, 22.1, 22.2, 22.3, 22.3, 22.4, 22.5, 22.5, 22.6, 22.7, 22.7, 22.8, 22.9, 22.9, 23.0, 23.1, 23.1, 23.2, 23.2, 23.3, 23.3, 23.4, 23.4, // D3
                ...Array(241).fill(23.4)
            ],
            p4_35: [
                null, 12.9, 13.1, 13.2, 13.4, 13.5, 13.7, 13.8, 13.9, 14.1, 14.2, 14.4, 14.5, 14.7, 14.8, 14.9, 15.1, 15.2, 15.3, 15.5, 15.6, 15.7, 15.9, 16.0, // D0
                16.1, 16.2, 16.4, 16.5, 16.6, 16.7, 16.9, 17.0, 17.1, 17.2, 17.4, 17.5, 17.6, 17.7, 17.8, 17.9, 18.0, 18.2, 18.3, 18.4, 18.5, 18.6, 18.7, 18.8, // D1
                18.9, 19.0, 19.1, 19.2, 19.3, 19.4, 19.5, 19.6, 19.7, 19.8, 19.9, 20.0, 20.1, 20.2, 20.2, 20.3, 20.4, 20.5, 20.6, 20.7, 20.8, 20.8, 20.9, 21.0, // D2
                21.1, 21.1, 21.2, 21.3, 21.4, 21.4, 21.5, 21.6, 21.6, 21.7, 21.8, 21.8, 21.9, 22.0, 22.0, 22.1, 22.2, 22.2, 22.3, 22.3, 22.4, 22.4, 22.5, 22.5, // D3
                ...Array(241).fill(22.5)
            ]
        };

        let babies = [{ id: Date.now(), name: '', bed: '', dob: '', tob: '', aogWeeks: 38, aogDays: 0, tcb: '', pre: '', post: '', neuro: false }];
        let renderTimeout = null;

        function toggleModal() {
            const modal = document.getElementById('guide-modal');
            modal.classList.toggle('hidden');
        }

        // Core Functions
        function getAssessmentTime() {
            const isManual = document.getElementById('override-toggle').checked;
            const mDate = document.getElementById('manual-date').value;
            const mTime = document.getElementById('manual-time').value;

            if (isManual && mDate && mTime) {
                return new Date(`${mDate}T${mTime}`);
            }
            return new Date();
        }

        function calculateHOL(dob, tob) {
            if (!dob || !tob) return null;
            const birth = new Date(`${dob}T${tob}`);
            const assessment = getAssessmentTime();
            const diffMs = assessment - birth;
            const diffHours = diffMs / 3600000;
            return Math.max(0, Math.floor(diffHours));
        }


function getAap2022Thresholds(hol, w, d, neuro, tcb) {

    if (hol === null || hol === undefined) {
        return { photo: null, dvet: null, zone: "Unknown" };
    }

    const gestationalAge = parseFloat(w || 0) + (parseFloat(d || 0) / 7);

    // Clamp HOL safely within dataset bounds
    const hour = Math.max(0, Math.min(336, Math.floor(hol)));

    // ----------------------------
    // Determine GA bucket
    // ----------------------------
    let gaKey = "35";

    if (gestationalAge >= 40) gaKey = "40";
    else if (gestationalAge >= 39) gaKey = "39";
    else if (gestationalAge >= 38) gaKey = "38";
    else if (gestationalAge >= 37) gaKey = "37";
    else if (gestationalAge >= 36) gaKey = "36";
    else gaKey = "35";

    // ----------------------------
    // Select correct dataset parts
    // ----------------------------
    const photoPart = neuro ? "p2" : "p1"; // Phototherapy
    const dvetPart  = neuro ? "p4" : "p3"; // Escalation

    const photoKey = `${photoPart}_${gaKey}`;
    const dvetKey  = `${dvetPart}_${gaKey}`;

    const photoArray = RAW_DATA[photoKey];
    const dvetArray  = RAW_DATA[dvetKey];

    if (!photoArray || !dvetArray) {
        return { photo: null, dvet: null, zone: "Data Error" };
    }

    const photo = photoArray[hour];
    const dvet  = dvetArray[hour];

    // ----------------------------
    // Clinical interpretation
    // ----------------------------
    let zone = "Below Treatment Threshold";

    if (tcb && photo !== null) {
        const val = parseFloat(tcb);

        if (val >= photo) zone = "Meets Phototherapy Threshold";
        else if (val >= photo - 2) zone = "Within 2 mg/dL of Threshold";
    }

    return {
        photo: photo !== null ? photo.toFixed(1) : null,
        dvet:  dvet  !== null ? dvet.toFixed(1)  : null,
        zone
    };
}

        function generateSingleBabyText(b) {
            const hol = calculateHOL(b.dob, b.tob);
            if (!b.bed && !b.name && !b.tcb) return "";

            let text = `‚úÖ ${b.bed || '---'} üë∂üèΩ${b.name || 'PATIENT'}\n`;
            
            if (hol !== null) {
                const { photo, dvet, zone } = getAap2022Thresholds(hol, b.aogWeeks, b.aogDays, b.neuro, b.tcb);
                const totalWeeks = parseFloat(b.aogWeeks || 0) + (parseFloat(b.aogDays || 0) / 7);
                let riskLabel = b.neuro ? "High Risk Neonate" : (totalWeeks < 38 ? "Medium Risk Neonate" : "Low Risk Neonate");

                text += `DOB: ${b.dob.replace(/-/g, '/')}\n`;
                text += `TOB: ${b.tob}\n`;
                text += `AOG: ${b.aogWeeks} weeks ${b.aogDays} days\n`;
                text += `HOL: ${hol}\n`;
                text += `${riskLabel}\n\n`;
                
                if (b.tcb) {
                    const isAbove = parseFloat(b.tcb) >= parseFloat(photo);
                    text += `TCB: ${b.tcb} mg/dL\n`;
                    text += `PHOTOLEVEL: ${isAbove ? 'ABOVE' : 'BELOW'} (${photo})\n`;
                    text += `DVET level: BELOW (${dvet})\n`;
                    text += `Bhutani Risk Zone: ${zone}\n`;
                }
            }

            if (b.pre !== '' && b.post !== '') {
                const p1 = parseInt(b.pre);
                const p2 = parseInt(b.post);
                const diff = Math.abs(p1 - p2);
                let result = "Passed";
                if (p1 < 90 || p2 < 90) result = "Failed";
                else if (p1 < 95 || p2 < 95 || diff > 3) result = "Repeat Screening (or Fail if 3rd)";

                text += `\nü´Ä CCHD ü´Ä\nPreductal: ${p1}%\nPostductal: ${p2}%\nResult: ${result}\n`;
            }
            return text;
        }

        function updateOutput() {
            const preview = document.getElementById('output-preview');
            const valid = babies.filter(b => b.bed || b.name || b.tcb || (b.pre && b.post));
            if (!valid.length) { preview.textContent = "Awaiting clinical data..."; return; }
            
            const flowers = ["üåº", "üå∏", "üå∫", "üåª", "üåπ", "üå∑", "üèµÔ∏è", "üéÄ", "üçÄ"];
            const sorted = [...valid].sort((a, b) => {
                const [aW, aR] = (a.bed || "0-0").split('-').map(v => parseInt(v) || 0);
                const [bW, bR] = (b.bed || "0-0").split('-').map(v => parseInt(v) || 0);
                if (aW !== bW) return aW - bW;
                return aR - bR;
            });

            const grouped = sorted.reduce((acc, b) => {
                const ward = (b.bed || "0-0").split('-')[0] || "??";
                if (!acc[ward]) acc[ward] = [];
                acc[ward].push(b);
                return acc;
            }, {});

            const assessmentNow = getAssessmentTime();
            const dateStr = `${assessmentNow.getMonth() + 1}/${assessmentNow.getDate()}`;
            const hr = assessmentNow.getHours();
            const ampm = hr >= 12 ? 'PM' : 'AM';
            const hr12 = hr % 12 || 12;
            
            let text = `üèãüèª TCB ROUNDS (${dateStr} ${hr12}${ampm}) üèãüèª\n\n`;
            Object.keys(grouped).forEach((ward, i) => {
                const fl = flowers[i % flowers.length];
                text += `${fl} WARD ${ward} ${fl}\n\n`;
                grouped[ward].forEach(b => { text += generateSingleBabyText(b) + `\n`; });
            });
            preview.textContent = text.trim();
        }

        function toggleOverride() {
            const isChecked = document.getElementById('override-toggle').checked;
            const container = document.getElementById('override-inputs');
            const label = document.getElementById('override-label');
            const mDateInput = document.getElementById('manual-date');
            const mTimeInput = document.getElementById('manual-time');
            
            if (isChecked) {
                container.classList.remove('hidden');
                label.textContent = "Assessment time";
                const now = new Date();
                mDateInput.value = now.toISOString().split('T')[0];
                mTimeInput.value = now.toTimeString().slice(0, 5);
            } else {
                container.classList.add('hidden');
                label.textContent = "manually input assessment time?";
            }
            updateOutput();
            render();
        }

        function updateBaby(id, field, value, immediate = false) {
            const b = babies.find(x => x.id === id);
            if (!b) return;

            if (field === 'neuro') { 
                b.neuro = !b.neuro; 
                render(); 
                return; 
            }

            b[field] = value;

            if (field === 'aogWeeks' || field === 'aogDays') {
                const w = parseFloat(b.aogWeeks || 0);
                const d = parseFloat(b.aogDays || 0);
                const totalWeeks = w + (d / 7);
            }

            if (immediate) { 
                render(); 
            } else {
                clearTimeout(renderTimeout);
                renderTimeout = setTimeout(() => { render(); }, 800); 
            }
        }

        function addBaby() {
            babies.push({ id: Date.now(), name: '', bed: '', dob: '', tob: '', aogWeeks: 38, aogDays: 0, tcb: '', pre: '', post: '', neuro: false });
            render();
        }

        function removeBaby(id) {
            if (babies.length > 1) { babies = babies.filter(x => x.id !== id); render(); }
        }

        function copySingleRow(id) {
            const b = babies.find(x => x.id === id);
            const text = generateSingleBabyText(b);
            if (text) {
                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
            }
        }

        function copyFullReport() {
            const el = document.createElement('textarea');
            el.value = document.getElementById('output-preview').textContent;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        }

        function render() {
            const container = document.getElementById('babies-container');
            const activeId = document.activeElement ? document.activeElement.id : null;

            container.innerHTML = babies.map(b => `
                <div class="neutral-card rounded-xl overflow-hidden flex relative shadow-sm border-l-4 ${b.neuro ? 'border-l-red-500' : 'border-l-indigo-500'}">
                    <button onclick="removeBaby(${b.id})" class="absolute top-1 left-1 text-slate-200 hover:text-red-400 z-10"><i class="fa-solid fa-circle-xmark text-[10px]"></i></button>
                    
                    <div class="flex-grow p-3 space-y-3 overflow-hidden">
                        <div class="flex flex-wrap gap-2">
                            <div class="w-[15%] min-w-[60px] input-group">
                                <label class="text-[7px] font-black text-slate-400 uppercase block"><i class="fa-solid fa-bed mr-1"></i>Bed</label>
                                <input id="bed-${b.id}" value="${b.bed}" oninput="updateBaby(${b.id}, 'bed', this.value)" class="w-full bg-transparent outline-none font-bold text-xs" placeholder="---">
                            </div>
                            <div class="flex-grow min-w-[120px] input-group">
                                <label class="text-[7px] font-black text-slate-400 uppercase block"><i class="fa-solid fa-user mr-1"></i>Patient Name</label>
                                <input id="name-${b.id}" value="${b.name}" oninput="updateBaby(${b.id}, 'name', this.value)" class="w-full bg-transparent outline-none font-bold text-xs uppercase" placeholder="Enter name...">
                            </div>
                            <div class="flex-grow md:w-[35%] min-w-[180px] input-group flex items-center gap-2">
                                <div class="flex-grow">
                                    <label class="text-[7px] font-black text-slate-400 uppercase block"><i class="fa-solid fa-baby mr-1"></i>Birth Date/Time</label>
                                    <div class="flex items-center gap-1">
                                        <input id="dob-${b.id}" type="date" value="${b.dob}" oninput="updateBaby(${b.id}, 'dob', this.value)" class="bg-transparent outline-none text-[10px] font-bold w-full">
                                        <input id="tob-${b.id}" type="time" value="${b.tob}" oninput="updateBaby(${b.id}, 'tob', this.value)" class="bg-transparent outline-none text-[10px] font-bold w-full">
                                    </div>
                                </div>
                                <div class="text-right border-l pl-2 border-slate-200 shrink-0">
                                    <label class="text-[7px] font-black text-slate-400 uppercase block">Age</label>
                                    <span class="text-xs font-black text-slate-700">${calculateHOL(b.dob, b.tob) ?? '--'}h</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2 items-stretch">
                            <div class="w-[20%] min-w-[80px] input-group flex justify-around items-center">
                                <div class="text-center">
                                    <label class="text-[7px] font-black text-slate-400 block uppercase"><i class="fa-solid fa-calendar-week mr-1"></i>Wk</label>
                                    <input id="wk-${b.id}" type="number" value="${b.aogWeeks}" oninput="updateBaby(${b.id}, 'aogWeeks', this.value)" class="w-full bg-transparent text-center font-bold text-xs">
                                </div>
                                <div class="h-4 w-[1px] bg-slate-200"></div>
                                <div class="text-center">
                                    <label class="text-[7px] font-black text-slate-400 block uppercase">Day</label>
                                    <input id="day-${b.id}" type="number" value="${b.aogDays}" oninput="updateBaby(${b.id}, 'aogDays', this.value)" class="w-full bg-transparent text-center font-bold text-xs">
                                </div>
                            </div>
                            <div class="w-[12%] min-w-[60px] input-group text-center">
                                <label class="text-[7px] font-black text-indigo-500 block uppercase"><i class="fa-solid fa-vial mr-1"></i>TcB</label>
                                <input id="tcb-${b.id}" type="number" step="0.1" value="${b.tcb}" oninput="updateBaby(${b.id}, 'tcb', this.value)" class="w-full bg-transparent text-center font-black text-xs text-indigo-700" placeholder="0.0">
                            </div>
                            <label onclick="updateBaby(${b.id}, 'neuro')" class="flex-grow min-w-[150px] input-group cursor-pointer transition-colors flex flex-col justify-center ${b.neuro ? 'risk-active' : 'hover:bg-slate-100'}">
                                <div class="flex items-center gap-1">
                                    <i class="fa-solid fa-triangle-exclamation text-[8px]"></i>
                                    <span class="text-[8px] font-black uppercase">Neurotoxicity Risk Factors</span>
                                    <span class="ml-auto text-[8px] font-black">${b.neuro ? 'YES' : 'NO'}</span>
                                </div>
                                <p class="text-[5px] leading-tight mt-0.5 opacity-70">GA < 38w ‚Ä¢ Albumin < 3 ‚Ä¢ DAT+/G6PD/Hemolysis ‚Ä¢ Sepsis ‚Ä¢ Clinical Instability (24h)</p>
                            </label>
                            <div class="w-[22%] min-w-[100px] input-group flex justify-around items-center">
                                <div class="text-center">
                                    <label class="text-[7px] font-black text-rose-400 block uppercase"><i class="fa-solid fa-heart-pulse mr-1"></i>Pre</label>
                                    <input id="pre-${b.id}" value="${b.pre}" oninput="updateBaby(${b.id}, 'pre', this.value)" class="w-full bg-transparent text-center font-bold text-xs">
                                </div>
                                <div class="h-4 w-[1px] bg-slate-200"></div>
                                <div class="text-center">
                                    <label class="text-[7px] font-black text-rose-400 block uppercase">Post</label>
                                    <input id="post-${b.id}" value="${b.post}" oninput="updateBaby(${b.id}, 'post', this.value)" class="w-full bg-transparent text-center font-bold text-xs">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="copySingleRow(${b.id})" class="copy-sidebar text-white">
                        <i class="fa-solid fa-copy text-xs mb-2"></i>
                        <span class="vertical-text text-[8px] font-bold uppercase tracking-widest whitespace-nowrap">Copy Results</span>
                    </button>
                </div>
            `).join('');
            
            if (activeId) {
                const el = document.getElementById(activeId);
                if (el) { el.focus(); if (el.tagName === 'INPUT' && (el.type === 'text' || !el.type)) { const val = el.value; el.value = ''; el.value = val; } }
            }
            updateOutput();
        }

        window.onload = function() {
            document.getElementById('manual-date').oninput = () => { updateOutput(); render(); };
            document.getElementById('manual-time').oninput = () => { updateOutput(); render(); };
            render();
        };
    </script>
</body>
</html>